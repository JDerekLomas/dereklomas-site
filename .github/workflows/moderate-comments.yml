name: Moderate Discussion Comments

on:
  discussion_comment:
    types: [created]

jobs:
  moderate:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-hide comment for review
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const sender = context.payload.sender;

            // Allow repo owner and collaborators through
            const owner = context.repo.owner;
            if (sender.login === owner) {
              console.log(`Comment from repo owner ${sender.login}, skipping moderation.`);
              return;
            }

            try {
              const { data: permLevel } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: sender.login,
              });
              if (['admin', 'write'].includes(permLevel.permission)) {
                console.log(`Comment from collaborator ${sender.login} (${permLevel.permission}), skipping.`);
                return;
              }
            } catch (e) {
              // Not a collaborator, proceed with moderation
            }

            // Minimize (hide) the comment pending review
            await github.graphql(`
              mutation($id: ID!) {
                minimizeComment(input: {
                  subjectId: $id,
                  classifier: OFF_TOPIC
                }) {
                  minimizedComment { isMinimized }
                }
              }
            `, { id: comment.node_id });

            console.log(`Hidden comment from ${sender.login} for review: "${comment.body.substring(0, 80)}..."`);
